name: CI
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
env:
  HOST: ${{secrets.HOST}}
  API_SECRET: ${{secrets.API_SECRET}}
  JWT_ACCESS_TOKEN_SECRET: ${{secrets.JWT_ACCESS_TOKEN_SECRET}}
  JWT_REFRESH_TOKEN_SECRET: ${{secrets.JWT_REFRESH_TOKEN_SECRET}}
  DATABASE_NAME: ${{secrets.DATABASE_NAME}}
  DATABASE_USERNAME: ${{secrets.DATABASE_USERNAME}}
  DATABASE_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
jobs:
  test:
    runs-on: debian-latest
    steps:
      - name: Checkout 
      - uses: actions/checkout@v3

      - name: Login to DockerHub Registry
      - uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Run API tests
      - run: docker compose --file docker-compose.test.yml up --build --abort-on-container-exit api

      - name: Run Web tests
      - run: docker compose --file docker-compose.test.yml up --build --abort-on-container-exit web